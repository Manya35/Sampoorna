<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sampoorna Chatbox</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50 text-gray-800 min-h-screen flex flex-col justify-between">

  <!-- Header -->
  <header class="bg-green-700 text-white p-6 shadow">
    <h1 class="text-2xl font-bold">Sampoorna Chat Assistant</h1>
    <p class="text-sm mt-1">Get suggestions for government schemes applicable to you</p>
  </header>

  <!-- Chat Container -->
  <main class="flex-1 p-4 overflow-y-auto space-y-4" id="chatContainer"></main>

  <!-- Quick Question Buttons -->
  <div class="flex gap-2 px-4 pb-4">
    <button class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded" onclick="sendPreset('What is PM Kisan Yojna?')">PM Kisan Yojna?</button>
    <button class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded" onclick="sendPreset('What schemes are available for FRA patta holders?')">FRA Patta Schemes</button>
    <button class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded" onclick="sendPreset('Schemes for small farmers')">Farmer Schemes</button>
  </div>

  <!-- Input -->
  <div class="flex p-4 border-t border-green-200 gap-2">
    <input id="userInput" type="text" placeholder="Ask a question..." 
           class="flex-1 px-4 py-2 rounded-lg border border-green-300 focus:outline-none focus:ring-2 focus:ring-green-500"/>
    <button onclick="sendMessage()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-500">Send</button>
    <button onclick="startAudio()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-400">ðŸŽ¤</button>
  </div>

  <script>
    const chatContainer = document.getElementById('chatContainer');

    function appendMessage(sender, text) {
      const msg = document.createElement('div');
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      msg.className = 'flex flex-col ' + (sender === 'user' ? 'items-end' : 'items-start');
      msg.innerHTML = `<div class="inline-block px-4 py-2 rounded-lg max-w-xs ${sender==='user'?'bg-green-600 text-white':'bg-white text-gray-800 shadow'}">${text}</div>
                       <span class="text-xs text-gray-500 mt-1">${time}</span>`;
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showTypingIndicator() {
      const indicator = document.createElement('div');
      indicator.id = 'typingIndicator';
      indicator.className = 'flex items-start space-x-2';
      indicator.innerHTML = `<div class="bg-white text-gray-800 shadow inline-block px-4 py-2 rounded-lg">Typing...</div>`;
      chatContainer.appendChild(indicator);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) indicator.remove();
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const text = input.value.trim();
      if (!text) return;
      appendMessage('user', text);
      input.value = '';
      showTypingIndicator();

      try {
        const res = await fetch('http://localhost:3000/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ prompt: text })
        });
        const data = await res.json();
        removeTypingIndicator();
        appendMessage('bot', data.answer);
      } catch (err) {
        removeTypingIndicator();
        appendMessage('bot', 'Error connecting to AI service.');
        console.error(err);
      }
    }

    function sendPreset(text) {
      document.getElementById('userInput').value = text;
      sendMessage();
    }

    function startAudio() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Your browser does not support voice input.');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.onresult = (event) => {
        const speechText = event.results[0][0].transcript;
        document.getElementById('userInput').value = speechText;
        sendMessage();
      };
      recognition.start();
    }
  </script>
</body>
</html>
